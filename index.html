<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Personales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #ec4899, #f472b6);
            color: white;
        }
        .tab-button {
            background: #fdf2f8;
            color: #be185d;
        }
        .tab-button:hover {
            background: #fce7f3;
        }
        /* AGREGAR ESTAS NUEVAS CLASES PARA CONTROLAR GR√ÅFICOS */
        .chart-container {
            height: 250px;
            position: relative;
        }
        .chart-container-sm {
            height: 200px;
            position: relative;
        }
        .chart-container-lg {
            height: 300px;
            position: relative;
        }
        .chart-container-xl {
            height: 350px;
            position: relative;
        }

        /* Estilos para el historial de pagos */
        .pago-item {
            border-left: 3px solid #10B981;
            background: #f0fdf4;
        }

        .deuda-detalle {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .deuda-detalle.open {
            max-height: 500px;
        }

        .historial-pagos {
            background: #f8fafc;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-50 to-rose-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üí∞ Finanzas Personales</h1>
            <p class="text-gray-600">Control completo de tus ingresos, gastos y metas financieras en soles</p>
        </header>
        <!-- FORMULARIO DE LOGIN -->
        <div id="loginSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-md mx-auto">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üîê Iniciar Sesi√≥n</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="tu@email.com">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                    <input type="password" id="loginPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    üöÄ Iniciar Sesi√≥n
                </button>
            </form>
            
            <!-- Bot√≥n para cambiar a registro -->
            <div class="mt-4 text-center">
                <p class="text-sm text-gray-600">¬øNo tienes cuenta? 
                    <button type="button" id="btnMostrarRegistro" class="text-pink-600 hover:text-pink-800 font-medium">Reg√≠strate aqu√≠</button>
                </p>
            </div>
        </div>
        <!-- FORMULARIO DE REGISTRO -->
        <div id="registroSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-md mx-auto hidden">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìù Crear Cuenta</h2>
        <form id="registroForm" class="space-y-4">
            <div>
                <label for="registroEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="registroEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="tu@email.com">
            </div>
            <div>
                <label for="registroPassword" class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                <input type="password" id="registroPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="M√≠nimo 6 caracteres">
            </div>
            <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Confirmar Contrase√±a</label>
                <input type="password" id="confirmPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Repite tu contrase√±a">
            </div>
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                ‚úÖ Crear Cuenta
            </button>
        </form>
        
        <!-- Bot√≥n para cambiar a login -->
        <div class="mt-4 text-center">
            <p class="text-sm text-gray-600">¬øYa tienes cuenta? 
                <button type="button" id="btnMostrarLogin" class="text-green-600 hover:text-green-800 font-medium">Inicia sesi√≥n aqu√≠</button>
            </p>
        </div>
        </div>
    <!-- Contenedor principal (se muestra despu√©s del login) -->
        <div id="mainApp" class="hidden">
            <!-- Navegaci√≥n por pesta√±as -->
            <nav class="bg-white rounded-xl shadow-lg p-2 mb-8">
                <div class="flex flex-wrap gap-2 justify-between items-center">
                    <div class="flex flex-wrap gap-2">
                        <button class="tab-button active px-4 py-2 rounded-lg transition duration-200 font-medium" data-tab="ingresos">üí∞ Ingresos</button>
                        <button class="tab-button px-4 py-2 rounded-lg transition duration-200 font-medium" data-tab="gastos">üí∏ Gastos</button>
                        <button class="tab-button px-4 py-2 rounded-lg transition duration-200 font-medium" data-tab="resumen">üìä Resumen</button>
                        <button class="tab-button px-4 py-2 rounded-lg transition duration-200 font-medium" data-tab="metas">üéØ Metas</button>
                        <button class="tab-button px-4 py-2 rounded-lg transition duration-200 font-medium" data-tab="presupuesto">üìÖ Presupuesto</button>
                        <button class="tab-button px-4 py-2 rounded-lg transition duration-200 font-medium" data-tab="anual">üìÜ Resumen Anual</button>
                        <button class="tab-button px-4 py-2 rounded-lg transition duration-200 font-medium" data-tab="deudas">üìã Deudas</button>
                        <button class="tab-button px-4 py-2 rounded-lg transition duration-200 font-medium" data-tab="prestamos">üè¶ Pr√©stamos</button>
                    </div>
                    <button onclick="cerrarSesion()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition duration-200 text-sm font-medium">
                        üö™ Cerrar Sesi√≥n
                    </button>
                </div>
            </nav>
            <main>
                <!-- SECCI√ìN INGRESOS -->
                <div id="ingresos" class="tab-content active">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-4 border-green-400">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">üí∞ Registrar Ingreso</h2>
                        <form id="ingresoForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="fechaIngreso" class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
                                    <input type="date" id="fechaIngreso" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="fuenteIngreso" class="block text-sm font-medium text-gray-700 mb-2">Fuente</label>
                                    <select id="fuenteIngreso" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Selecciona fuente</option>
                                        <option value="Sueldo">üíº Sueldo</option>
                                        <option value="Freelance">üíª Freelance</option>
                                        <option value="Venta">üõçÔ∏è Venta</option>
                                        <option value="Inversi√≥n">üìà Inversi√≥n</option>
                                        <option value="Bono">üéÅ Bono</option>
                                        <option value="Pr√©stamo">üí∏ Pr√©stamo</option>
                                        <option value="Otros">üì¶ Otros</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="montoIngreso" class="block text-sm font-medium text-gray-700 mb-2">Monto (S/)</label>
                                    <input type="number" id="montoIngreso" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="0.00">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="tipoIngreso" class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                    <select id="tipoIngreso" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Selecciona tipo</option>
                                        <option value="Fijo">üîí Fijo</option>
                                        <option value="Variable">üîÑ Variable</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="metodoPagoIngreso" class="block text-sm font-medium text-gray-700 mb-2">M√©todo de Pago</label>
                                    <select id="metodoPagoIngreso" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Selecciona m√©todo</option>
                                        <option value="Efectivo">üíµ Efectivo</option>
                                        <option value="Tarjeta">üí≥ Tarjeta</option>
                                        <option value="Transferencia">üè¶ Transferencia</option>
                                        <option value="Yape/Plin">üì± Yape/Plin</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="comentariosIngreso" class="block text-sm font-medium text-gray-700 mb-2">Comentarios</label>
                                    <input type="text" id="comentariosIngreso" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Comentarios adicionales...">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                ‚ûï Agregar Ingreso
                            </button>
                        </form>
                    </div>

                    <!-- Resumen y gr√°fico de ingresos -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Total Mensual</h3>
                            <div class="text-3xl font-bold text-green-600 mb-2">S/ <span id="totalIngresosMes">0.00</span></div>
                            <p class="text-gray-600">Ingresos del mes actual</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">üìà Evoluci√≥n de Ingresos</h3>
                            <div class="chart-container">
                                <canvas id="ingresosChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de ingresos -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Historial de Ingresos</h3>
                            <div class="text-lg font-bold text-green-600">Total: S/ <span id="totalIngresos">0.00</span></div>
                        </div>
                        <div id="listaIngresos" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No hay ingresos registrados</p>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN GASTOS -->
                <div id="gastos" class="tab-content">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-4 border-pink-400">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">üí∏ Registrar Gasto</h2>
                        <form id="gastoForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="fechaGasto" class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
                                    <input type="date" id="fechaGasto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="categoriaGasto" class="block text-sm font-medium text-gray-700 mb-2">Categor√≠a</label>
                                    <select id="categoriaGasto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                                        <option value="">Selecciona categor√≠a</option>
                                        <option value="Alimentaci√≥n">üçΩÔ∏è Alimentaci√≥n</option>
                                        <option value="Transporte">üöó Transporte</option>
                                        <option value="Ocio">üé¨ Ocio</option>
                                        <option value="Salud">üè• Salud</option>
                                        <option value="Servicios">üí° Servicios</option>
                                        <option value="Compras">üõçÔ∏è Compras</option>
                                        <option value="Educaci√≥n">üìö Educaci√≥n</option>
                                        <option value="Deudas">üßæ Deudas</option>
                                        <option value="Ahorro">üíé Ahorro</option>
                                        <option value="Otros">üì¶ Otros</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="montoGasto" class="block text-sm font-medium text-gray-700 mb-2">Monto (S/)</label>
                                    <input type="number" id="montoGasto" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="0.00">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="descripcionGasto" class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                                    <input type="text" id="descripcionGasto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="Descripci√≥n del gasto">
                                </div>
                                <div>
                                    <label for="metodoPagoGasto" class="block text-sm font-medium text-gray-700 mb-2">M√©todo de Pago</label>
                                    <select id="metodoPagoGasto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                                        <option value="">Selecciona m√©todo</option>
                                        <option value="Efectivo">üíµ Efectivo</option>
                                        <option value="Tarjeta">üí≥ Tarjeta</option>
                                        <option value="Transferencia">üè¶ Transferencia</option>
                                        <option value="Yape/Plin">üì± Yape/Plin</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tipoGasto" class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                    <select id="tipoGasto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                                        <option value="">Selecciona tipo</option>
                                        <option value="Fijo">üîí Fijo</option>
                                        <option value="Variable">üîÑ Variable</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                ‚ûï Agregar Gasto
                            </button>
                        </form>
                    </div>

                    <!-- Resumen y gr√°fico de gastos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Gastos por Categor√≠a</h3>
                            <div id="gastosPorCategoria" class="space-y-2">
                                <p class="text-gray-500">No hay gastos registrados</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">üå∏ Distribuci√≥n de Gastos</h3>
                            <div class="chart-container">
                                <canvas id="gastosChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Lista de gastos -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Historial de Gastos</h3>
                            <div class="text-lg font-bold text-pink-600">Total: S/ <span id="totalGastos">0.00</span></div>
                        </div>
                        <div id="listaGastos" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No hay gastos registrados</p>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN RESUMEN FINANCIERO -->
                <div id="resumen" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-400">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üí∞ Ingresos del Mes</h3>
                            <p class="text-3xl font-bold text-green-600">S/ <span id="resumenIngresosMes">0.00</span></p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-pink-400">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üí∏ Gastos del Mes</h3>
                            <p class="text-3xl font-bold text-pink-600">S/ <span id="resumenGastosMes">0.00</span></p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-400">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üìä Balance Mensual</h3>
                            <p class="text-3xl font-bold" id="balanceTexto">S/ <span id="resumenBalance">0.00</span></p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-400">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üíé % de Ahorro</h3>
                            <p class="text-3xl font-bold text-purple-600"><span id="porcentajeAhorro">0</span>%</p>
                        </div>
                    </div>

                    <!-- Indicador visual -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üéØ Estado Financiero</h3>
                        <div id="indicadorFinanciero" class="p-6 rounded-lg text-center">
                            <div class="text-4xl mb-2" id="iconoEstado">üí∞</div>
                            <div class="text-xl font-semibold" id="textoEstado">Registra tus primeros movimientos</div>
                            <div class="text-gray-600 mt-2" id="descripcionEstado">Agrega ingresos y gastos para ver tu estado financiero</div>
                        </div>
                    </div>

                    <!-- Gr√°ficos comparativos -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">üìà Comparaci√≥n Mensual</h3>
                            <div class="chart-container-lg">
                                <canvas id="comparativoChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Evoluci√≥n del Balance</h3>
                            <div class="chart-container-lg">
                                <canvas id="balanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- SECCI√ìN METAS -->
                <div id="metas" class="tab-content">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-4 border-purple-400">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">üéØ Nueva Meta de Ahorro</h2>
                        <form id="metaForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="nombreMeta" class="block text-sm font-medium text-gray-700 mb-2">Meta</label>
                                    <input type="text" id="nombreMeta" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Ej: Viaje, Fondo de emergencia, Nuevo celular">
                                </div>
                                <div>
                                    <label for="montoObjetivo" class="block text-sm font-medium text-gray-700 mb-2">Monto Objetivo (S/)</label>
                                    <input type="number" id="montoObjetivo" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="0.00">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="ahorroActual" class="block text-sm font-medium text-gray-700 mb-2">Ahorro Actual (S/)</label>
                                    <input type="number" id="ahorroActual" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="0.00">
                                </div>
                                <div>
                                    <label for="fechaLimite" class="block text-sm font-medium text-gray-700 mb-2">Fecha L√≠mite</label>
                                    <input type="date" id="fechaLimite" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                üéØ Crear Meta
                            </button>
                        </form>
                    </div>

                    <!-- Lista de metas -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Mis Metas de Ahorro</h3>
                        <div id="listaMetas" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No hay metas registradas</p>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN PRESUPUESTO MENSUAL -->
                 
                <div id="presupuesto" class="tab-content">
                        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Total Mensual</h3>
                        <div class="text-3xl font-bold text-green-600 mb-2">S/ <span id="totalIngresosMesPresupuesto">0.00</span></div>
                        <p class="text-gray-600">Ingresos del mes actual</p>
                         </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-4 border-blue-400">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìÖ Configurar Presupuesto Mensual</h2>
                        <form id="presupuestoForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="categoriaPresupuesto" class="block text-sm font-medium text-gray-700 mb-2">Categor√≠a</label>
                                    <select id="categoriaPresupuesto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Selecciona categor√≠a</option>
                                        <option value="Alimentaci√≥n">üçΩÔ∏è Alimentaci√≥n</option>
                                        <option value="Transporte">üöó Transporte</option>
                                        <option value="Ocio">üé¨ Ocio</option>
                                        <option value="Salud">üè• Salud</option>
                                        <option value="Servicios">üí° Servicios</option>
                                        <option value="Compras">üõçÔ∏è Compras</option>
                                        <option value="Educaci√≥n">üìö Educaci√≥n</option>
                                        <option value="Deudas">üßæ Deudas</option>
                                        <option value="Ahorro">üíé Ahorro</option>
                                        <option value="Otros">üì¶ Otros</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="montoPresupuesto" class="block text-sm font-medium text-gray-700 mb-2">Presupuesto Planeado (S/)</label>
                                    <input type="number" id="montoPresupuesto" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0.00">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                üìÖ Establecer Presupuesto
                            </button>
                        </form>
                    </div>

                    <!-- Gr√°fico comparativo -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üå∏ Gr√°fico Comparativo</h3>
                        <div class="chart-container-lg">
                            <canvas id="presupuestoChart"></canvas>
                        </div>
                    </div>

                    <!-- Tabla comparativa -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Presupuesto vs Gasto Real</h3>
                        <div id="tablaPresupuesto" class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3">Categor√≠a</th>
                                        <th class="px-6 py-3">Presupuesto Planeado</th>
                                        <th class="px-6 py-3">Gasto Real</th>
                                        <th class="px-6 py-3">Diferencia</th>
                                        <th class="px-6 py-3">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="cuerpoTablaPresupuesto">
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay presupuestos configurados</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN RESUMEN ANUAL -->
                <div id="anual" class="tab-content">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìÜ Resumen Anual <span id="anioActual">2024</span></h2>
                        
                        <!-- Selector de a√±o -->
                        <div class="mb-6">
                            <label for="selectorAnio" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar A√±o</label>
                            <select id="selectorAnio" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                            </select>
                        </div>

                        <!-- Tabla resumen anual -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-700 uppercase bg-gradient-to-r from-pink-50 to-rose-50">
                                    <tr>
                                        <th class="px-6 py-3">Mes</th>
                                        <th class="px-6 py-3">Ingresos (S/)</th>
                                        <th class="px-6 py-3">Gastos (S/)</th>
                                        <th class="px-6 py-3">Ahorro (S/)</th>
                                        <th class="px-6 py-3">Balance (S/)</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaResumenAnual">
                                    <!-- Se llena din√°micamente -->
                                </tbody>
                                <tfoot class="bg-gray-50 font-semibold">
                                    <tr>
                                        <td class="px-6 py-3">TOTAL ANUAL</td>
                                        <td class="px-6 py-3 text-green-600" id="totalIngresosAnual">S/ 0.00</td>
                                        <td class="px-6 py-3 text-pink-600" id="totalGastosAnual">S/ 0.00</td>
                                        <td class="px-6 py-3 text-purple-600" id="totalAhorroAnual">S/ 0.00</td>
                                        <td class="px-6 py-3" id="totalBalanceAnual">S/ 0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Gr√°fico de tendencia anual -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìà Tendencia Anual</h3>
                        <div class="chart-container-xl">
                            <canvas id="tendenciaAnualChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN DEUDAS -->
                <div id="deudas" class="tab-content">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-4 border-orange-400">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìã Registrar Deuda</h2>
                        <form id="deudaForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="tipoDeuda" class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                    <select id="tipoDeuda" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option value="">Selecciona tipo</option>
                                        <option value="Deuda">üî¥ Empresa</option>
                                        <option value="Deuda">üîµ Personal</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="conceptoDeuda" class="block text-sm font-medium text-gray-700 mb-2">Concepto</label>
                                    <input type="text" id="conceptoDeuda" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Ej: Pr√©stamo personal, Tarjeta de cr√©dito, etc.">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="montoTotalDeuda" class="block text-sm font-medium text-gray-700 mb-2">Monto Total (S/)</label>
                                    <input type="number" id="montoTotalDeuda" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="0.00">
                                </div>
                                <div>
                                    <label for="saldoPendiente" class="block text-sm font-medium text-gray-700 mb-2">Saldo Pendiente (S/)</label>
                                    <input type="number" id="saldoPendiente" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="0.00">
                                </div>
                                <div>
                                    <label for="tasaInteres" class="block text-sm font-medium text-gray-700 mb-2">Tasa de Inter√©s (%)</label>
                                    <input type="number" id="tasaInteres" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="0.00">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="fechaInicioDeuda" class="block text-sm font-medium text-gray-700 mb-2">Fecha de Inicio</label>
                                    <input type="date" id="fechaInicioDeuda" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="fechaVencimiento" class="block text-sm font-medium text-gray-700 mb-2">Fecha de Vencimiento</label>
                                    <input type="date" id="fechaVencimiento" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                            </div>
                            <div>
                                <label for="descripcionDeuda" class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                                <textarea id="descripcionDeuda" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Descripci√≥n adicional..."></textarea>
                            </div>
                            <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                ‚ûï Agregar Deuda/Pr√©stamo
                            </button>
                        </form>
                    </div>

                    <!-- Resumen de deudas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-400">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üî¥ Total Deudas</h3>
                            <p class="text-3xl font-bold text-red-600">S/ <span id="totalDeudas">0.00</span></p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-400">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üí∞ Total Deuda Pagada</h3>
                            <p class="text-3xl font-bold text-green-600">S/ <span id="totalDeudaPagada">0.00</span></p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-400">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">‚öñÔ∏è Balance Neto</h3>
                            <p class="text-3xl font-bold" id="balanceDeudasTexto">S/ <span id="balanceDeudas">0.00</span></p>
                        </div>
                    </div>

                    <!-- Lista de deudas y pr√©stamos -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Lista de Deudas</h3>
                        <div id="listaDeudas" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No hay deudas o pr√©stamos registrados</p>
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN PR√âSTAMOS -->
                <div id="prestamos" class="tab-content">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-4 border-blue-400">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">üè¶ Registrar Pr√©stamo</h2>
                        <form id="prestamoForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="conceptoPrestamo" class="block text-sm font-medium text-gray-700 mb-2">Concepto</label>
                                    <input type="text" id="conceptoPrestamo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: Pr√©stamo a Juan, Inversi√≥n en negocio, etc.">
                                </div>
                                <div>
                                    <label for="deudorPrestamo" class="block text-sm font-medium text-gray-700 mb-2">Deudor</label>
                                    <input type="text" id="deudorPrestamo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nombre de la persona/empresa">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="montoTotalPrestamo" class="block text-sm font-medium text-gray-700 mb-2">Monto Total (S/)</label>
                                    <input type="number" id="montoTotalPrestamo" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0.00">
                                </div>
                                <div>
                                    <label for="saldoPendientePrestamo" class="block text-sm font-medium text-gray-700 mb-2">Saldo Pendiente (S/)</label>
                                    <input type="number" id="saldoPendientePrestamo" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0.00">
                                </div>
                                <div>
                                    <label for="tasaInteresPrestamo" class="block text-sm font-medium text-gray-700 mb-2">Tasa de Inter√©s (%)</label>
                                    <input type="number" id="tasaInteresPrestamo" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0.00">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="fechaInicioPrestamo" class="block text-sm font-medium text-gray-700 mb-2">Fecha de Inicio</label>
                                    <input type="date" id="fechaInicioPrestamo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="fechaVencimientoPrestamo" class="block text-sm font-medium text-gray-700 mb-2">Fecha de Vencimiento</label>
                                    <input type="date" id="fechaVencimientoPrestamo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            <div>
                                <label for="descripcionPrestamo" class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                                <textarea id="descripcionPrestamo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Descripci√≥n adicional..."></textarea>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                ‚ûï Agregar Pr√©stamo
                            </button>
                        </form>
                    </div>

                    <!-- Resumen de pr√©stamos -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-400">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üí∞ Total Pr√©stamos Activos</h3>
                            <p class="text-3xl font-bold text-green-600">S/ <span id="totalPrestamosActivos">0.00</span></p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-400">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üè¶ Total Recuperado</h3>
                            <p class="text-3xl font-bold text-blue-600">S/ <span id="totalPrestamosRecuperados">0.00</span></p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-400">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üìà Balance Pr√©stamos</h3>
                            <p class="text-3xl font-bold text-purple-600">S/ <span id="balancePrestamos">0.00</span></p>
                        </div>
                    </div>

                    <!-- Lista de pr√©stamos -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Lista de Pr√©stamos</h3>
                        <div id="listaPrestamos" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No hay pr√©stamos registrados</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import  { 
        getFirestore, 
        collection, 
        addDoc, 
        query, 
        onSnapshot, 
        where, 
        getDocs, 
        deleteDoc, 
        doc,
        updateDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        setPersistence,
        browserSessionPersistence,
        inMemoryPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBszUwx47pfvpzm4Eut3UAKrY10TpyNeWg",
      authDomain: "finanzaspersonales-51acf.firebaseapp.com",
      projectId: "finanzaspersonales-51acf",
      storageBucket: "finanzaspersonales-51acf.firebasestorage.app",
      messagingSenderId: "1078068297249",
      appId: "1:1078068297249:web:fc2f684461897765baed60",
      measurementId: "G-6GYDFNBS7Z"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    // Configurar persistencia de sesi√≥n (solo durante la sesi√≥n del navegador)
    setPersistence(auth, browserSessionPersistence)
        .then(() => {
            console.log("Persistencia configurada: sesi√≥n del navegador");
        })
        .catch((error) => {
            console.error("Error configurando persistencia:", error);
        });
    // Elementos del DOM
    const loginSection = document.getElementById('loginSection');
    const mainApp = document.getElementById('mainApp');
    const loginForm = document.getElementById('loginForm');

    // Variables globales - SE MANTIENE IGUAL
        let ingresos = [];
        let gastos = [];
        let metas = [];
        let presupuestos = [];
        let deudas = [];
        let deudasChart;
        let prestamos = [];
        // Charts globales - SE MANTIENE IGUAL
        let ingresosChart, gastosChart, comparativoChart, balanceChart, presupuestoChart, tendenciaAnualChart;

        // MODIFICADO: Variable para controlar actualizaciones de gr√°ficos
        let graficosCargados = false;
        let inicializando = true;
        // Establecer fechas actuales - SE MANTIENE IGUAL
        document.getElementById('fechaIngreso').valueAsDate = new Date();
        document.getElementById('fechaGasto').valueAsDate = new Date();
        document.getElementById('anioActual').textContent = new Date().getFullYear();

        // Funciones para cambiar entre formularios
        function mostrarRegistro() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('registroSection').classList.remove('hidden');
        }
        
        function mostrarLogin() {
            document.getElementById('registroSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
        }
    
        document.addEventListener('DOMContentLoaded', function() {
        const btnMostrarRegistro = document.getElementById('btnMostrarRegistro');
        const btnMostrarLogin = document.getElementById('btnMostrarLogin');
        
        if (btnMostrarRegistro) {
            btnMostrarRegistro.addEventListener('click', mostrarRegistro);
        }
        
        if (btnMostrarLogin) {
            btnMostrarLogin.addEventListener('click', mostrarLogin);
        }
    });
        // Funci√≥n para REGISTRAR usuario
        async function registrarUsuario(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log("Usuario registrado exitosamente:", userCredential.user);
                return { exito: true, mensaje: "¬°Cuenta creada exitosamente! ‚úÖ" };
            } catch (error) {
                console.error("Error al registrar:", error);
                
                if (error.code === 'auth/email-already-in-use') {
                    return { exito: false, mensaje: "‚ùå Este email ya est√° registrado" };
                } else if (error.code === 'auth/invalid-email') {
                    return { exito: false, mensaje: "‚ùå Email inv√°lido" };
                } else if (error.code === 'auth/weak-password') {
                    return { exito: false, mensaje: "‚ùå La contrase√±a debe tener al menos 6 caracteres" };
                } else {
                    return { exito: false, mensaje: "‚ùå Error al crear cuenta: " + error.message };
                }
            }
        }

        // Funci√≥n para INICIAR SESI√ìN
        async function iniciarSesion(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Sesi√≥n iniciada exitosamente:", userCredential.user);
                return { exito: true, mensaje: "¬°Bienvenido/a! üéâ" };
            } catch (error) {
                console.error("Error al iniciar sesi√≥n:", error);
                
                if (error.code === 'auth/user-not-found') {
                    return { exito: false, mensaje: "‚ùå Usuario no encontrado. Reg√≠strate primero." };
                } else if (error.code === 'auth/wrong-password') {
                    return { exito: false, mensaje: "‚ùå Contrase√±a incorrecta" };
                } else if (error.code === 'auth/invalid-email') {
                    return { exito: false, mensaje: "‚ùå Email inv√°lido" };
                } else {
                    return { exito: false, mensaje: "‚ùå Error al iniciar sesi√≥n: " + error.message };
                }
            }
        }
        
        // Manejar formulario de REGISTRO
        document.getElementById('registroForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('registroEmail').value;
            const password = document.getElementById('registroPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validaciones
            if (password !== confirmPassword) {
                alert("‚ùå Las contrase√±as no coinciden");
                return;
            }
            
            if (password.length < 6) {
                alert("‚ùå La contrase√±a debe tener al menos 6 caracteres");
                return;
            }
            
            const boton = e.target.querySelector('button');
            const textoOriginal = boton.textContent;
            boton.textContent = "‚è≥ Creando cuenta...";
            boton.disabled = true;
            
            const resultado = await registrarUsuario(email, password);
            
            if (resultado.exito) {
                alert(resultado.mensaje);
                document.getElementById('registroForm').reset();
                // El usuario queda autom√°ticamente logueado despu√©s del registro
            } else {
                alert(resultado.mensaje);
                boton.textContent = textoOriginal;
                boton.disabled = false;
            }
        });
    
        // Manejar formulario de LOGIN (modificado)
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert("‚ùå Por favor ingresa email y contrase√±a");
                return;
            }
            
            const boton = e.target.querySelector('button');
            const textoOriginal = boton.textContent;
            boton.textContent = "‚è≥ Iniciando sesi√≥n...";
            boton.disabled = true;
            
            const resultado = await iniciarSesion(email, password);
            
            if (!resultado.exito) {
                alert(resultado.mensaje);
                boton.textContent = textoOriginal;
                boton.disabled = false;
            }
        });
        // Observador de estado de autenticaci√≥n
        onAuthStateChanged(auth, async (user) => {
            console.log("Estado de autenticaci√≥n:", user ? `Usuario: ${user.email}` : "Sin usuario");
            
            // Evitar ejecuci√≥n durante la inicializaci√≥n
            if (inicializando) {
                inicializando = false;
                console.log("Inicializaci√≥n completada");
            }
            
            if (user) {
                // Usuario autenticado
                console.log("Mostrando aplicaci√≥n para:", user.email);
                loginSection.classList.add('hidden');
                mainApp.classList.remove('hidden');

                //ESTA L√çNEA PARA OCULTAR EL FORMULARIO DE REGISTRO
                document.getElementById('registroSection').classList.add('hidden');
                // Configurar listeners en tiempo real
                configurarListenersTiempoReal(user.uid);
                
                // Cargar gr√°ficos despu√©s de un delay
                setTimeout(() => {
                    actualizarGraficoIngresos();
                    actualizarGraficoGastos();
                    actualizarResumenAnual();
                    graficosCargados = true;
                }, 1000);
                
            } else {
                // No hay usuario autenticado
                console.log("Mostrando formulario de login");
                loginSection.classList.remove('hidden');
                mainApp.classList.add('hidden');
                // AGREGAR ESTA L√çNEA PARA ASEGURAR QUE EL REGISTRO TAMBI√âN EST√â OCULTO
                document.getElementById('registroSection').classList.add('hidden');
                
                // Forzar limpieza completa
                ingresos = [];
                gastos = [];
                metas = [];
                presupuestos = [];
                
                // Actualizar UI
                actualizarIngresos();
                actualizarGastos();
                actualizarMetas();
                actualizarPresupuesto();
                actualizarResumen();
                
                // Limpiar gr√°ficos
                if (ingresosChart) { ingresosChart.destroy(); ingresosChart = null; }
                if (gastosChart) { gastosChart.destroy(); gastosChart = null; }
                if (comparativoChart) { comparativoChart.destroy(); comparativoChart = null; }
                if (balanceChart) { balanceChart.destroy(); balanceChart = null; }
                if (presupuestoChart) { presupuestoChart.destroy(); presupuestoChart = null; }
                if (tendenciaAnualChart) { tendenciaAnualChart.destroy(); tendenciaAnualChart = null; }
                
                graficosCargados = false;
            }
        });
                
        // Funci√≥n para cerrar sesi√≥n - MEJORADA
        window.cerrarSesion = async function() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                try {
                    // Destruir todos los gr√°ficos antes de cerrar sesi√≥n
                    if (ingresosChart) ingresosChart.destroy();
                    if (gastosChart) gastosChart.destroy();
                    if (comparativoChart) comparativoChart.destroy();
                    if (balanceChart) balanceChart.destroy();
                    if (presupuestoChart) presupuestoChart.destroy();
                    if (tendenciaAnualChart) tendenciaAnualChart.destroy();
                    
                    // Limpiar datos locales
                    ingresos = [];
                    gastos = [];
                    metas = [];
                    presupuestos = [];
                    
                    // Cerrar sesi√≥n
                    await signOut(auth);
                    
                    // Forzar actualizaci√≥n de la UI
                    actualizarIngresos();
                    actualizarGastos();
                    actualizarMetas();
                    actualizarPresupuesto();
                    actualizarResumen();
                    
                    console.log("Sesi√≥n cerrada y datos limpiados");
                    
                } catch (error) {
                    console.error("Error al cerrar sesi√≥n:", error);
                    alert("Error al cerrar sesi√≥n: " + error.message);
                }
            }
        };
        // Navegaci√≥n por pesta√±as - MODIFICADO: Optimizado para no recargar gr√°ficos innecesariamente
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById(tabId).classList.add('active');
                button.classList.add('active');
                
                // MODIFICADO: Solo actualizar gr√°ficos si ya est√°n cargados inicialmente
                if (graficosCargados) {
                    setTimeout(() => {
                        if (tabId === 'ingresos' && document.getElementById('ingresosChart')) actualizarGraficoIngresos();
                        if (tabId === 'gastos' && document.getElementById('gastosChart')) actualizarGraficoGastos();
                        if (tabId === 'resumen') actualizarGraficosResumen();
                        if (tabId === 'presupuesto') {
                            actualizarPresupuesto(); // AGREGAR ESTA L√çNEA
                            if (document.getElementById('presupuestoChart')) actualizarGraficoPresupuesto();
                        }
                        if (tabId === 'anual') actualizarResumenAnual();
                        if (tabId === 'deudas') actualizarDeudas();
                        if (tabId === 'prestamos') actualizarPrestamos();
                    }, 100);
                }
            });
        });

        // Formularios - SE MANTIENE IGUAL (solo Firebase)
        document.getElementById('ingresoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nuevoIngreso = {
                id: Date.now(),
                fecha: document.getElementById('fechaIngreso').value,
                fuente: document.getElementById('fuenteIngreso').value,
                monto: parseFloat(document.getElementById('montoIngreso').value),
                tipo: document.getElementById('tipoIngreso').value,
                metodoPago: document.getElementById('metodoPagoIngreso').value,
                comentarios: document.getElementById('comentariosIngreso').value,
                createdAt: new Date()
            };
            
            try {
                if (auth.currentUser) {
                    await addDoc(
                        collection(db, "users", auth.currentUser.uid, "ingresos"),
                        nuevoIngreso
                    );
                }
            } catch (err) {
                console.warn("No se pudo guardar ingreso en Firestore:", err);
                alert("Error al guardar el ingreso. Intenta nuevamente.");
            }
            
            document.getElementById('ingresoForm').reset();
            document.getElementById('fechaIngreso').valueAsDate = new Date();
        });

        document.getElementById('gastoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nuevoGasto = {
                id: Date.now(),
                fecha: document.getElementById('fechaGasto').value,
                categoria: document.getElementById('categoriaGasto').value,
                descripcion: document.getElementById('descripcionGasto').value,
                monto: parseFloat(document.getElementById('montoGasto').value),
                metodoPago: document.getElementById('metodoPagoGasto').value,
                tipo: document.getElementById('tipoGasto').value,
                createdAt: new Date()
            };
            
            try {
                if (auth.currentUser) {
                    await addDoc(
                        collection(db, "users", auth.currentUser.uid, "gastos"),
                        nuevoGasto
                    );

                    if (nuevoGasto.categoria === 'Deudas') {
                    // listar deudas por concepto para elegir
                    const opciones = deudas.map(d => `${d.id} - ${d.concepto} (Pend: S/ ${d.saldoPendiente.toFixed(2)})`).join('\n');
                    const elegido = prompt(`Aplica este pago a qu√© deuda?\n${opciones}\n\nEscribe el ID num√©rico (antes del gui√≥n):`, "");
                    if (elegido) {
                        const target = deudas.find(d => d.id === parseInt(elegido));
                        if (target) {
                        // registrar pago igual que abonarDeuda
                        try {
                            const basePath = `users/${auth.currentUser.uid}/deudas`;
                            const docId = await findDocIdByCustomId(basePath, target.id);
                            if (docId) {
                            const nuevoSaldo = Math.max(0, target.saldoPendiente - nuevoGasto.monto);
                            await updateDoc(doc(db, basePath, docId), { saldoPendiente: nuevoSaldo });
                            await addDoc(collection(db, basePath, docId, "pagos"), {
                                monto: nuevoGasto.monto,
                                fecha: nuevoGasto.fecha || new Date().toISOString(),
                                nota: nuevoGasto.descripcion || "Pago registrado desde Gastos"
                            });
                            }
                        } catch (e) {
                            console.warn("No se pudo vincular el gasto con la deuda:", e);
                        }
                        }
                    }
                    }

                    if (nuevoGasto.categoria === 'Ahorro') {
                    // elegir meta
                    if (metas.length === 0) {
                        alert("No tienes metas a√∫n. Crea una meta para registrar aportes.");
                    } else {
                        let metaTarget = null;
                        if (metas.length === 1) {
                        metaTarget = metas[0];
                        } else {
                        const ops = metas.map(m => `${m.id} - ${m.nombre} (Ahorrado: S/ ${m.ahorroActual.toFixed(2)})`).join('\n');
                        const elegido = prompt(`¬øA cu√°l meta aplicar este ahorro?\n${ops}\n\nEscribe el ID num√©rico:`, "");
                        if (elegido) metaTarget = metas.find(m => m.id === parseInt(elegido));
                        }

                        if (metaTarget) {
                        try {
                            const basePath = `users/${auth.currentUser.uid}/metas`;
                            const docId = await findDocIdByCustomId(basePath, metaTarget.id);
                            if (docId) {
                            const nuevoAhorro = (metaTarget.ahorroActual || 0) + nuevoGasto.monto;
                            await updateDoc(doc(db, basePath, docId), { ahorroActual: nuevoAhorro });
                            await addDoc(collection(db, basePath, docId, "aportes"), {
                                monto: nuevoGasto.monto,
                                fecha: nuevoGasto.fecha || new Date().toISOString(),
                                nota: nuevoGasto.descripcion || "Aporte desde Gastos"
                            });
                            }
                        } catch (e) {
                            console.warn("No se pudo registrar el aporte en la meta:", e);
                        }
                        }
                    }
                    }
                }
            } catch (err) {
                console.warn("No se pudo guardar gasto en Firestore:", err);
                alert("Error al guardar el gasto. Intenta nuevamente.");
            }
            
            document.getElementById('gastoForm').reset();
            document.getElementById('fechaGasto').valueAsDate = new Date();
        });

        document.getElementById('metaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nuevaMeta = {
                id: Date.now(),
                nombre: document.getElementById('nombreMeta').value,
                montoObjetivo: parseFloat(document.getElementById('montoObjetivo').value),
                ahorroActual: parseFloat(document.getElementById('ahorroActual').value) || 0,
                fechaLimite: document.getElementById('fechaLimite').value,
                createdAt: new Date()
            };
            
            try {
                if (auth.currentUser) {
                    await addDoc(
                        collection(db, "users", auth.currentUser.uid, "metas"),
                        nuevaMeta
                    );
                }
            } catch (err) {
                console.warn("No se pudo guardar meta en Firestore:", err);
                alert("Error al guardar la meta. Intenta nuevamente.");
            }
            
            document.getElementById('metaForm').reset();
        });

        document.getElementById('presupuestoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const presupuestoDoc = {
                id: Date.now(),
                categoria: document.getElementById('categoriaPresupuesto').value,
                monto: parseFloat(document.getElementById('montoPresupuesto').value),
                createdAt: new Date()
            };
            
            try {
                if (auth.currentUser) {
                    await addDoc(
                        collection(db, "users", auth.currentUser.uid, "presupuestos"),
                        presupuestoDoc
                    );
                }
            } catch (err) {
                console.warn("No se pudo guardar presupuesto en Firestore:", err);
                alert("Error al guardar el presupuesto. Intenta nuevamente.");
            }
            
            document.getElementById('presupuestoForm').reset();
        });

        // Selector de a√±o - SE MANTIENE IGUAL
        document.getElementById('selectorAnio').addEventListener('change', actualizarResumenAnual);
        
        // fOrm de Deudas
        document.getElementById('deudaForm').addEventListener('submit', async (e) => {e.preventDefault();
    
            const nuevaDeuda = {
                id: Date.now(),
                tipo: document.getElementById('tipoDeuda').value,
                concepto: document.getElementById('conceptoDeuda').value,
                montoTotal: parseFloat(document.getElementById('montoTotalDeuda').value),
                saldoPendiente: parseFloat(document.getElementById('saldoPendiente').value),
                tasaInteres: parseFloat(document.getElementById('tasaInteres').value) || 0,
                fechaInicio: document.getElementById('fechaInicioDeuda').value,
                fechaVencimiento: document.getElementById('fechaVencimiento').value,
                descripcion: document.getElementById('descripcionDeuda').value,
                createdAt: new Date()
            };
            
            try {
                if (auth.currentUser) {
                    await addDoc(
                        collection(db, "users", auth.currentUser.uid, "deudas"),
                        nuevaDeuda
                    );
                }
            } catch (err) {
                console.warn("No se pudo guardar deuda en Firestore:", err);
                alert("Error al guardar la deuda/pr√©stamo. Intenta nuevamente.");
            }
            
            document.getElementById('deudaForm').reset();
            document.getElementById('fechaInicioDeuda').valueAsDate = new Date();
        });
        
        // Formulario de Pr√©stamos
        document.getElementById('prestamoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nuevoPrestamo = {
                id: Date.now(),
                concepto: document.getElementById('conceptoPrestamo').value,
                deudor: document.getElementById('deudorPrestamo').value,
                montoTotal: parseFloat(document.getElementById('montoTotalPrestamo').value),
                saldoPendiente: parseFloat(document.getElementById('saldoPendientePrestamo').value),
                tasaInteres: parseFloat(document.getElementById('tasaInteresPrestamo').value) || 0,
                fechaInicio: document.getElementById('fechaInicioPrestamo').value,
                fechaVencimiento: document.getElementById('fechaVencimientoPrestamo').value,
                descripcion: document.getElementById('descripcionPrestamo').value,
                createdAt: new Date()
            };
            
            try {
                if (auth.currentUser) {
                    await addDoc(
                        collection(db, "users", auth.currentUser.uid, "prestamos"),
                        nuevoPrestamo
                    );
                }
            } catch (err) {
                console.warn("No se pudo guardar pr√©stamo en Firestore:", err);
                alert("Error al guardar el pr√©stamo. Intenta nuevamente.");
            }
            
            document.getElementById('prestamoForm').reset();
            document.getElementById('fechaInicioPrestamo').valueAsDate = new Date();
        });
        
        // Funciones de actualizaci√≥n - SE MANTIENE IGUAL (solo la l√≥gica de UI)
        function actualizarTodo() {
            actualizarIngresos();
            actualizarGastos();
            actualizarResumen();
            actualizarMetas();
            actualizarPresupuesto();
            actualizarDeudas();
        }

        function obtenerMesActual() {
            const ahora = new Date();
            return `${ahora.getFullYear()}-${String(ahora.getMonth() + 1).padStart(2, '0')}`;
        }

        function filtrarPorMes(datos, mes) {
            return datos.filter(item => item.fecha.startsWith(mes));
        }

        function actualizarIngresos() {
            const mesActual = obtenerMesActual();
            const ingresosMes = filtrarPorMes(ingresos, mesActual);
            const totalMes = ingresosMes.reduce((sum, ingreso) => sum + ingreso.monto, 0);
            const totalGeneral = ingresos.reduce((sum, ingreso) => sum + ingreso.monto, 0);
            
            document.getElementById('totalIngresosMes').textContent = totalMes.toFixed(2);
            document.getElementById('totalIngresos').textContent = totalGeneral.toFixed(2);
            
            const lista = document.getElementById('listaIngresos');
            
            if (ingresos.length === 0) {
                lista.innerHTML = '<p class="text-gray-500 text-center py-8">No hay ingresos registrados</p>';
                return;
            }
            
            const ingresosOrdenados = [...ingresos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            lista.innerHTML = ingresosOrdenados.map(ingreso => `
                <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="text-lg">${getFuenteIcon(ingreso.fuente)}</span>
                            <h4 class="font-semibold text-gray-800">${ingreso.fuente}</h4>
                            <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">${ingreso.tipo}</span>
                        </div>
                        <p class="text-sm text-gray-600">${formatearFecha(ingreso.fecha)} ‚Ä¢ ${ingreso.metodoPago}</p>
                        ${ingreso.comentarios ? `<p class="text-sm text-gray-500 mt-1">${ingreso.comentarios}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xl font-bold text-green-600">S/ ${ingreso.monto.toFixed(2)}</span>
                        <button onclick="eliminarIngreso('${ingreso.id}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-lg transition duration-200">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function actualizarGastos() {
            const totalGeneral = gastos.reduce((sum, gasto) => sum + gasto.monto, 0);
            document.getElementById('totalGastos').textContent = totalGeneral.toFixed(2);
            
            const gastosPorCategoria = {};
            gastos.forEach(gasto => {
                gastosPorCategoria[gasto.categoria] = (gastosPorCategoria[gasto.categoria] || 0) + gasto.monto;
            });
            
            const contenedorCategorias = document.getElementById('gastosPorCategoria');
            if (Object.keys(gastosPorCategoria).length === 0) {
                contenedorCategorias.innerHTML = '<p class="text-gray-500">No hay gastos registrados</p>';
            } else {
                contenedorCategorias.innerHTML = Object.entries(gastosPorCategoria)
                    .sort(([,a], [,b]) => b - a)
                    .map(([categoria, monto]) => `
                        <div class="flex justify-between items-center p-2 bg-pink-50 rounded">
                            <span class="text-sm font-medium">${getCategoriaIcon(categoria)} ${categoria}</span>
                            <span class="text-sm font-bold text-pink-600">S/ ${monto.toFixed(2)}</span>
                        </div>
                    `).join('');
            }
            
            const lista = document.getElementById('listaGastos');
            
            if (gastos.length === 0) {
                lista.innerHTML = '<p class="text-gray-500 text-center py-8">No hay gastos registrados</p>';
                return;
            }
            
            const gastosOrdenados = [...gastos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            lista.innerHTML = gastosOrdenados.map(gasto => `
                <div class="flex items-center justify-between p-4 bg-pink-50 rounded-lg border border-pink-200">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="text-lg">${getCategoriaIcon(gasto.categoria)}</span>
                            <h4 class="font-semibold text-gray-800">${gasto.descripcion}</h4>
                            <span class="text-sm bg-pink-100 text-pink-800 px-2 py-1 rounded-full">${gasto.categoria}</span>
                        </div>
                        <p class="text-sm text-gray-600">${formatearFecha(gasto.fecha)} ‚Ä¢ ${gasto.metodoPago} ‚Ä¢ ${gasto.tipo}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xl font-bold text-pink-600">S/ ${gasto.monto.toFixed(2)}</span>
                        <button onclick="eliminarGasto('${gasto.id}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-lg transition duration-200">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function actualizarResumen() {
            const mesActual = obtenerMesActual();
            const ingresosMes = filtrarPorMes(ingresos, mesActual);
            const gastosMes = filtrarPorMes(gastos, mesActual);
            
            const totalIngresosMes = ingresosMes.reduce((sum, ingreso) => sum + ingreso.monto, 0);
            const totalGastosMes = gastosMes.reduce((sum, gasto) => sum + gasto.monto, 0);
            const balance = totalIngresosMes - totalGastosMes;
            const porcentajeAhorro = totalIngresosMes > 0 ? ((balance / totalIngresosMes) * 100) : 0;
            
            document.getElementById('resumenIngresosMes').textContent = totalIngresosMes.toFixed(2);
            document.getElementById('resumenGastosMes').textContent = totalGastosMes.toFixed(2);
            document.getElementById('resumenBalance').textContent = balance.toFixed(2);
            document.getElementById('porcentajeAhorro').textContent = porcentajeAhorro.toFixed(1);
            
            const indicador = document.getElementById('indicadorFinanciero');
            const icono = document.getElementById('iconoEstado');
            const texto = document.getElementById('textoEstado');
            const descripcion = document.getElementById('descripcionEstado');
            const balanceTexto = document.getElementById('balanceTexto');
            
            if (totalIngresosMes === 0 && totalGastosMes === 0) {
                indicador.className = 'p-6 rounded-lg text-center bg-gray-100';
                icono.textContent = 'üí∞';
                texto.textContent = 'Registra tus primeros movimientos';
                descripcion.textContent = 'Agrega ingresos y gastos para ver tu estado financiero';
                balanceTexto.className = 'text-3xl font-bold text-gray-600';
            } else if (porcentajeAhorro >= 20) {
                indicador.className = 'p-6 rounded-lg text-center bg-green-100 border-2 border-green-300';
                icono.textContent = 'üåü';
                texto.textContent = '¬°Excelente ahorro!';
                descripcion.textContent = `Est√°s ahorrando ${porcentajeAhorro.toFixed(1)}% de tus ingresos`;
                balanceTexto.className = 'text-3xl font-bold text-green-600';
            } else if (porcentajeAhorro >= 0) {
                indicador.className = 'p-6 rounded-lg text-center bg-yellow-100 border-2 border-yellow-300';
                icono.textContent = '‚öñÔ∏è';
                texto.textContent = 'Balance equilibrado';
                descripcion.textContent = 'Puedes mejorar tu ahorro reduciendo algunos gastos';
                balanceTexto.className = 'text-3xl font-bold text-yellow-600';
            } else {
                indicador.className = 'p-6 rounded-lg text-center bg-pink-100 border-2 border-pink-300';
                icono.textContent = '‚ö†Ô∏è';
                texto.textContent = 'Gasto alto';
                descripcion.textContent = 'Tus gastos superan tus ingresos este mes';
                balanceTexto.className = 'text-3xl font-bold text-pink-600';
            }
        }

        function actualizarMetas() {
            const lista = document.getElementById('listaMetas');
            
            if (metas.length === 0) {
                lista.innerHTML = '<p class="text-gray-500 text-center py-8">No hay metas registradas</p>';
                return;
            }
            
            lista.innerHTML = metas.map(meta => {
                const progreso = (meta.ahorroActual / meta.montoObjetivo) * 100;
                const diasRestantes = meta.fechaLimite ? Math.ceil((new Date(meta.fechaLimite) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                const alerta80 = progreso >= 80;
                
                return `
                <div class="p-4 ${alerta80 ? 'bg-yellow-50 border-2 border-yellow-300' : 'bg-purple-50'} rounded-lg border">
                    ${alerta80 ? '<div class="text-yellow-600 text-sm font-medium mb-2">üéâ ¬°Casi alcanzas tu meta!</div>' : ''}
                    <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="font-semibold text-gray-800 text-lg">üéØ ${meta.nombre}</h4>
                        <p class="text-sm text-gray-600">S/ ${meta.ahorroActual.toFixed(2)} de S/ ${meta.montoObjetivo.toFixed(2)}</p>
                        ${diasRestantes !== null ? `<p class="text-sm text-gray-500">${diasRestantes > 0 ? `${diasRestantes} d√≠as restantes` : 'Meta vencida'}</p>` : ''}
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-purple-600">${progreso.toFixed(1)}%</p>
                        <div class="flex gap-2 justify-end mt-1">
                        <button onclick="actualizarAhorroMeta('${meta.id}')" class="text-purple-600 hover:text-purple-800 text-sm">üí∞ Actualizar</button>
                        <button onclick="toggleHistorialMeta('${meta.id}')" class="text-gray-700 hover:text-gray-900 text-sm">üìú Historial</button>
                        <button onclick="eliminarMeta('${meta.id}')" class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è</button>
                        </div>
                    </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-purple-500 h-3 rounded-full transition-all duration-300" style="width: ${Math.min(progreso, 100)}%"></div>
                    </div>
                    <div class="mt-2 flex justify-between text-sm">
                    <span class="text-gray-500">Faltan S/ ${(meta.montoObjetivo - meta.ahorroActual).toFixed(2)}</span>
                    </div>

                    <!-- HISTORIAL DE APORTES -->
                    <div id="historial-meta-${meta.id}" class="deuda-detalle mt-3">
                    <div class="historial-pagos p-3">
                        <div class="text-sm text-gray-600">Cargando historial...</div>
                    </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function actualizarPresupuesto() {
            const tabla = document.getElementById('cuerpoTablaPresupuesto');
            
            if (presupuestos.length === 0) {
                tabla.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay presupuestos configurados</td></tr>';
                return;
            }
            
            const mesActual = obtenerMesActual();
            const gastosMes = filtrarPorMes(gastos, mesActual);
            const ingresosMesX = filtrarPorMes(ingresos, mesActual);
            const totalMesX = ingresosMesX.reduce((s,i) => s + i.monto, 0);
            const elTotalPresu = document.getElementById('totalIngresosMesPresupuesto');
            if (elTotalPresu) elTotalPresu.textContent = totalMes.toFixed(2);
            
            tabla.innerHTML = presupuestos.map(presupuesto => {
                const gastoReal = gastosMes
                    .filter(gasto => gasto.categoria === presupuesto.categoria)
                    .reduce((sum, gasto) => sum + gasto.monto, 0);
                
                const diferencia = presupuesto.monto - gastoReal;
                const estado = diferencia >= 0 ? 'Dentro del presupuesto' : 'Presupuesto excedido';
                const colorEstado = diferencia >= 0 ? 'text-green-600' : 'text-pink-600';
                
                return `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">${getCategoriaIcon(presupuesto.categoria)} ${presupuesto.categoria}</td>
                        <td class="px-6 py-4">S/ ${presupuesto.monto.toFixed(2)}</td>
                        <td class="px-6 py-4">S/ ${gastoReal.toFixed(2)}</td>
                        <td class="px-6 py-4 ${diferencia >= 0 ? 'text-green-600' : 'text-pink-600'}">S/ ${diferencia.toFixed(2)}</td>
                        <td class="px-6 py-4 ${colorEstado}">${estado}</td>
                    </tr>
                `;
            }).join('');
        }

        function actualizarResumenAnual() {
            const anioSeleccionado = document.getElementById('selectorAnio').value;
            const tabla = document.getElementById('tablaResumenAnual');
            
            const meses = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            let totalIngresosAnual = 0;
            let totalGastosAnual = 0;
            let totalAhorroAnual = 0;
            
            const datosAnuales = [];
            
            tabla.innerHTML = meses.map((mes, index) => {
                const mesNumero = String(index + 1).padStart(2, '0');
                const fechaMes = `${anioSeleccionado}-${mesNumero}`;
                
                const ingresosMes = filtrarPorMes(ingresos, fechaMes);
                const gastosMes = filtrarPorMes(gastos, fechaMes);
                
                const totalIngresos = ingresosMes.reduce((sum, ingreso) => sum + ingreso.monto, 0);
                const totalGastos = gastosMes.reduce((sum, gasto) => sum + gasto.monto, 0);
                const ahorro = totalIngresos > 0 ? totalIngresos - totalGastos : 0;
                const balance = totalIngresos - totalGastos;
                
                totalIngresosAnual += totalIngresos;
                totalGastosAnual += totalGastos;
                totalAhorroAnual += ahorro;
                
                datosAnuales.push({
                    mes,
                    ingresos: totalIngresos,
                    gastos: totalGastos,
                    balance
                });
                
                return `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">${mes}</td>
                        <td class="px-6 py-4 text-green-600">S/ ${totalIngresos.toFixed(2)}</td>
                        <td class="px-6 py-4 text-pink-600">S/ ${totalGastos.toFixed(2)}</td>
                        <td class="px-6 py-4 text-purple-600">S/ ${ahorro.toFixed(2)}</td>
                        <td class="px-6 py-4 ${balance >= 0 ? 'text-green-600' : 'text-red-600'}">S/ ${balance.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('totalIngresosAnual').textContent = `S/ ${totalIngresosAnual.toFixed(2)}`;
            document.getElementById('totalGastosAnual').textContent = `S/ ${totalGastosAnual.toFixed(2)}`;
            document.getElementById('totalAhorroAnual').textContent = `S/ ${totalAhorroAnual.toFixed(2)}`;
            
            const balanceAnual = totalIngresosAnual - totalGastosAnual;
            const elementoBalance = document.getElementById('totalBalanceAnual');
            elementoBalance.textContent = `S/ ${balanceAnual.toFixed(2)}`;
            elementoBalance.className = `px-6 py-3 ${balanceAnual >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            actualizarGraficoTendenciaAnual(datosAnuales);
        }

        function actualizarDeudas() {
            // Calcular total de deudas pendientes
            const totalDeudasPendientes = deudas.reduce((sum, deuda) => sum + deuda.saldoPendiente, 0);
            
            // Calcular total de deuda pagada
            const totalDeudaPagada = deudas.reduce((sum, deuda) => sum + (deuda.montoTotal - deuda.saldoPendiente), 0);
            
            // El balance neto ahora muestra el total pendiente (negativo)
            const balanceDeudas = -totalDeudasPendientes;
            
            document.getElementById('totalDeudas').textContent = totalDeudasPendientes.toFixed(2);
            document.getElementById('totalDeudaPagada').textContent = totalDeudaPagada.toFixed(2);
            document.getElementById('balanceDeudas').textContent = balanceDeudas.toFixed(2);
            
            const balanceTexto = document.getElementById('balanceDeudasTexto');
            if (balanceDeudas > 0) {
                balanceTexto.className = 'text-3xl font-bold text-green-600';
            } else if (balanceDeudas < 0) {
                balanceTexto.className = 'text-3xl font-bold text-red-600';
            } else {
                balanceTexto.className = 'text-3xl font-bold text-gray-600';
            }
            
            const lista = document.getElementById('listaDeudas');
            
            if (deudas.length === 0) {
                lista.innerHTML = '<p class="text-gray-500 text-center py-8">No hay deudas registradas</p>';
                return;
            }
            
            const deudasOrdenadas = [...deudas].sort((a, b) => new Date(b.fechaInicio) - new Date(a.fechaInicio));
            
            lista.innerHTML = deudasOrdenadas.map(deuda => {
                const progreso = ((deuda.montoTotal - deuda.saldoPendiente) / deuda.montoTotal) * 100;
                const diasRestantes = deuda.fechaVencimiento ? Math.ceil((new Date(deuda.fechaVencimiento) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                const deudaPagada = deuda.montoTotal - deuda.saldoPendiente;

                return `
                    <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-lg">üî¥</span>
                                    <h4 class="font-semibold text-gray-800">${deuda.concepto}</h4>
                                    <span class="text-sm bg-red-100 text-red-800 px-2 py-1 rounded-full">Deuda</span>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                                    <div><span class="font-medium">Total:</span> S/ ${deuda.montoTotal.toFixed(2)}</div>
                                    <div><span class="font-medium">Pendiente:</span> S/ ${deuda.saldoPendiente.toFixed(2)}</div>
                                    <div><span class="font-medium">Pagado:</span> S/ ${deudaPagada.toFixed(2)}</div>
                                    ${deuda.tasaInteres > 0 ? `<div><span class="font-medium">Inter√©s:</span> ${deuda.tasaInteres}%</div>` : ''}
                                    ${diasRestantes !== null ? `<div><span class="font-medium">${diasRestantes > 0 ? 'D√≠as restantes' : 'Vencido'}:</span> ${Math.abs(diasRestantes)}</div>` : ''}
                                </div>
                                ${deuda.descripcion ? `<p class="text-sm text-gray-500 mt-2">${deuda.descripcion}</p>` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="abonarDeuda('${deuda.id}')" class="text-green-600 hover:text-green-800 text-sm font-medium">üí∞ Abonar</button>
                                <button onclick="toggleHistorialDeuda('${deuda.id}')" class="text-gray-700 hover:text-gray-900 text-sm font-medium">üìú Historial</button>
                                <button onclick="eliminarDeuda('${deuda.id}')" class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-red-500 h-2 rounded-full transition-all duration-300" style="width: ${Math.min(progreso, 100)}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Pagado: ${progreso.toFixed(1)}%</span>
                            <span>Faltan: S/ ${deuda.saldoPendiente.toFixed(2)}</span>
                        </div>

                        <!-- HISTORIAL DE PAGOS (plegable) -->
                        <div id="historial-deuda-${deuda.id}" class="deuda-detalle mt-3">
                            <div class="historial-pagos p-3">
                                <div class="text-sm text-gray-600">Cargando historial...</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        // MODIFICADO: Funciones de gr√°ficos optimizadas para mejor rendimiento
        function actualizarGraficoIngresos() {
            const ctx = document.getElementById('ingresosChart');
            if (!ctx) return;
            
            // Destruir gr√°fico existente si hay uno
            if (ingresosChart) {
                ingresosChart.destroy();
            }
            
            // Obtener datos de los √∫ltimos 6 meses
            const mesesData = [];
            const ingresosData = [];
            
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date();
                fecha.setMonth(fecha.getMonth() - i);
                const mesStr = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                const ingresosMes = filtrarPorMes(ingresos, mesStr);
                const total = ingresosMes.reduce((sum, ingreso) => sum + ingreso.monto, 0);
                
                mesesData.push(fecha.toLocaleDateString('es-ES', { month: 'short' }));
                ingresosData.push(total);
            }
            
            // MODIFICADO: Configuraci√≥n optimizada del gr√°fico
            ingresosChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: mesesData,
                    datasets: [{
                        label: 'Ingresos (S/)',
                        data: ingresosData,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 1,
                        tension: 0.1,
                        fill: true,
                        pointBackgroundColor: '#10B981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 1,
                        pointRadius: 2,
                        pointHoverRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                            layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 6 },
                            bodyFont: { size: 6 },
                            padding: 5
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: { size: 5 },
                                maxTicksLimit: 6,
                                padding: 5,
                                callback: function(value) {
                                    return 'S/ ' + value.toLocaleString('es-PE');
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 6 },
                                padding: 5
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function actualizarGraficoGastos() {
            const ctx = document.getElementById('gastosChart');
            if (!ctx) return;
            
            if (gastosChart) {
                gastosChart.destroy();
            }
            
            const gastosPorCategoria = {};
            gastos.forEach(gasto => {
                gastosPorCategoria[gasto.categoria] = (gastosPorCategoria[gasto.categoria] || 0) + gasto.monto;
            });

            // MODIFICADO: Colores optimizados
            const coloresRosa = [
                '#F472B6', '#EC4899', '#DB2777', '#BE185D',
                '#F9A8D4', '#FBCFE8', '#FDA4AF', '#FB7185'
            ];

            // MODIFICADO: Configuraci√≥n optimizada del gr√°fico de doughnut
            gastosChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(gastosPorCategoria),
                    datasets: [{
                        data: Object.values(gastosPorCategoria),
                        backgroundColor: coloresRosa,
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '30%',
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 7,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: { size: 6 },
                                boxWidth: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: S/ ${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        function actualizarGraficosResumen() {
            actualizarGraficoComparativo();
            actualizarGraficoBalance();
        }

        function actualizarGraficoComparativo() {
            const ctx = document.getElementById('comparativoChart');
            if (!ctx) return;
            
            if (comparativoChart) {
                comparativoChart.destroy();
            }
            
            const mesActual = obtenerMesActual();
            const ingresosMes = filtrarPorMes(ingresos, mesActual);
            const gastosMes = filtrarPorMes(gastos, mesActual);
            
            const totalIngresosMes = ingresosMes.reduce((sum, ingreso) => sum + ingreso.monto, 0);
            const totalGastosMes = gastosMes.reduce((sum, gasto) => sum + gasto.monto, 0);
            const balance = totalIngresosMes - totalGastosMes;
            
            // MODIFICADO: Configuraci√≥n optimizada del gr√°fico de barras
            comparativoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Gastos', 'Balance'],
                    datasets: [{
                        data: [totalIngresosMes, totalGastosMes, balance],
                        backgroundColor: [
                            '#10B981', 
                            '#F472B6', 
                            balance >= 0 ? '#3B82F6' : '#EF4444'
                        ],
                        borderWidth: 0,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `S/ ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: { size: 6 },
                                callback: function(value) {
                                    return 'S/ ' + value.toLocaleString('es-PE');
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 6 }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function actualizarGraficoBalance() {
            const ctx = document.getElementById('balanceChart');
            if (!ctx) return;
            
            if (balanceChart) {
                balanceChart.destroy();
            }
            
            const mesesData = [];
            const balanceData = [];
            
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date();
                fecha.setMonth(fecha.getMonth() - i);
                const mesStr = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                
                const ingresosMes = filtrarPorMes(ingresos, mesStr);
                const gastosMes = filtrarPorMes(gastos, mesStr);
                
                const totalIngresos = ingresosMes.reduce((sum, ingreso) => sum + ingreso.monto, 0);
                const totalGastos = gastosMes.reduce((sum, gasto) => sum + gasto.monto, 0);
                const balance = totalIngresos - totalGastos;
                
                mesesData.push(fecha.toLocaleDateString('es-ES', { month: 'short' }));
                balanceData.push(balance);
            }
            
            // MODIFICADO: Configuraci√≥n optimizada del gr√°fico de l√≠nea
            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: mesesData,
                    datasets: [{
                        label: 'Balance (S/)',
                        data: balanceData,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 1,
                        tension: 0.1,
                        fill: true,
                        pointBackgroundColor: '#3B82F6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 1,
                        pointRadius: 2,
                        pointHoverRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    return 'S/ ' + value.toLocaleString('es-PE');
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 6 }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }
        
        function actualizarGraficoPresupuesto() {
            const ctx = document.getElementById('presupuestoChart');
            if (!ctx) return;
            
            if (presupuestoChart) {
                presupuestoChart.destroy();
            }
            
            if (presupuestos.length === 0) return;
            
            const mesActual = obtenerMesActual();
            const gastosMes = filtrarPorMes(gastos, mesActual);
            
            const categorias = [];
            const presupuestosData = [];
            const gastosRealesData = [];
            
            presupuestos.forEach(presupuesto => {
                const gastoReal = gastosMes
                    .filter(gasto => gasto.categoria === presupuesto.categoria)
                    .reduce((sum, gasto) => sum + gasto.monto, 0);
                
                categorias.push(presupuesto.categoria);
                presupuestosData.push(presupuesto.monto);
                gastosRealesData.push(gastoReal);
            });
            
            // MODIFICADO: Configuraci√≥n optimizada del gr√°fico de barras agrupadas
            presupuestoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categorias,
                    datasets: [
                        {
                            label: 'Presupuesto Planeado',
                            data: presupuestosData,
                            backgroundColor: '#F3E8FF',
                            borderColor: '#C084FC',
                            borderWidth: 1,
                            borderRadius: 2
                        },
                        {
                            label: 'Gasto Real',
                            data: gastosRealesData,
                            backgroundColor: '#F472B6',
                            borderColor: '#DB2777',
                            borderWidth: 1,
                            borderRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 6 },
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: { size: 6 },
                                callback: function(value) {
                                    return 'S/ ' + value.toLocaleString('es-PE');
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 6 }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function actualizarGraficoTendenciaAnual(datosAnuales) {
            const ctx = document.getElementById('tendenciaAnualChart');
            if (!ctx) return;
            
            if (tendenciaAnualChart) {
                tendenciaAnualChart.destroy();
            }
            
            const meses = datosAnuales.map(d => d.mes);
            const ingresos = datosAnuales.map(d => d.ingresos);
            const gastos = datosAnuales.map(d => d.gastos);
            const balance = datosAnuales.map(d => d.balance);
            
            // MODIFICADO: Configuraci√≥n optimizada del gr√°fico de tendencia
            tendenciaAnualChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [
                        {
                            label: 'Ingresos (S/)',
                            data: ingresos,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 1,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Gastos (S/)',
                            data: gastos,
                            borderColor: '#F472B6',
                            backgroundColor: 'rgba(244, 114, 182, 0.1)',
                            borderWidth: 1,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Balance (S/)',
                            data: balance,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 1,
                            tension: 0.1,
                            fill: false,
                            borderDash: [2, 2]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 6 },
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: { size: 6 },
                                callback: function(value) {
                                    return 'S/ ' + value.toLocaleString('es-PE');
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 6 }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function actualizarPrestamos() {
            // Calcular total de pr√©stamos activos (saldo pendiente)
            const totalPrestamosActivos = prestamos.reduce((sum, prestamo) => sum + prestamo.saldoPendiente, 0);
            
            // Calcular total recuperado
            const totalPrestamosRecuperados = prestamos.reduce((sum, prestamo) => sum + (prestamo.montoTotal - prestamo.saldoPendiente), 0);
            
            // Balance total (lo que te deben)
            const balancePrestamos = totalPrestamosActivos;

            document.getElementById('totalPrestamosActivos').textContent = totalPrestamosActivos.toFixed(2);
            document.getElementById('totalPrestamosRecuperados').textContent = totalPrestamosRecuperados.toFixed(2);
            document.getElementById('balancePrestamos').textContent = balancePrestamos.toFixed(2);
            
            const lista = document.getElementById('listaPrestamos');
            
            if (prestamos.length === 0) {
                lista.innerHTML = '<p class="text-gray-500 text-center py-8">No hay pr√©stamos registrados</p>';
                return;
            }
            
            const prestamosOrdenados = [...prestamos].sort((a, b) => new Date(b.fechaInicio) - new Date(a.fechaInicio));
            
            lista.innerHTML = prestamosOrdenados.map(prestamo => {
                const progreso = ((prestamo.montoTotal - prestamo.saldoPendiente) / prestamo.montoTotal) * 100;
                const diasRestantes = prestamo.fechaVencimiento ? Math.ceil((new Date(prestamo.fechaVencimiento) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                const prestamoRecuperado = prestamo.montoTotal - prestamo.saldoPendiente;

                return `
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-lg">üè¶</span>
                                    <h4 class="font-semibold text-gray-800">${prestamo.concepto}</h4>
                                    <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Pr√©stamo</span>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                                    <div><span class="font-medium">Deudor:</span> ${prestamo.deudor}</div>
                                    <div><span class="font-medium">Total:</span> S/ ${prestamo.montoTotal.toFixed(2)}</div>
                                    <div><span class="font-medium">Pendiente:</span> S/ ${prestamo.saldoPendiente.toFixed(2)}</div>
                                    <div><span class="font-medium">Recuperado:</span> S/ ${prestamoRecuperado.toFixed(2)}</div>
                                    ${prestamo.tasaInteres > 0 ? `<div><span class="font-medium">Inter√©s:</span> ${prestamo.tasaInteres}%</div>` : ''}
                                    ${diasRestantes !== null ? `<div><span class="font-medium">${diasRestantes > 0 ? 'D√≠as restantes' : 'Vencido'}:</span> ${Math.abs(diasRestantes)}</div>` : ''}
                                </div>
                                ${prestamo.descripcion ? `<p class="text-sm text-gray-500 mt-2">${prestamo.descripcion}</p>` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="abonarPrestamo('${prestamo.id}')" class="text-green-600 hover:text-green-800 text-sm font-medium">üí∞ Cobrar</button>
                                <button onclick="toggleHistorialPrestamo('${prestamo.id}')" class="text-gray-700 hover:text-gray-900 text-sm font-medium">üìú Historial</button>
                                <button onclick="eliminarPrestamo('${prestamo.id}')" class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${Math.min(progreso, 100)}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Recuperado: ${progreso.toFixed(1)}%</span>
                            <span>Faltan: S/ ${prestamo.saldoPendiente.toFixed(2)}</span>
                        </div>

                        <!-- HISTORIAL DE COBROS (plegable) -->
                        <div id="historial-prestamo-${prestamo.id}" class="deuda-detalle mt-3">
                            <div class="historial-pagos p-3">
                                <div class="text-sm text-gray-600">Cargando historial...</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }        
        // Funciones auxiliares - SE MANTIENE IGUAL
        function getFuenteIcon(fuente) {
            const iconos = {
                'Sueldo': 'üíº',
                'Freelance': 'üíª',
                'Venta': 'üõçÔ∏è',
                'Inversi√≥n': 'üìà',
                'Bono': 'üéÅ',
                'Pr√©stamo': 'üí∏',
                'Otros': 'üì¶'
            };
            return iconos[fuente] || 'üì¶';
        }

        function getCategoriaIcon(categoria) {
            const iconos = {
                'Alimentaci√≥n': 'üçΩÔ∏è',
                'Transporte': 'üöó',
                'Ocio': 'üé¨',
                'Salud': 'üè•',
                'Servicios': 'üí°',
                'Compras': 'üõçÔ∏è',
                'Educaci√≥n': 'üìö',
                'Deudas': 'üßæ',
                'Ahorro': 'üíé',
                'Otros': 'üì¶'
            };
            return iconos[categoria] || 'üì¶';
        }

        function formatearFecha(fecha) {
            return new Date(fecha).toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        // ====== BUSCAR DOC FIRESTORE POR CAMPO id (tu id personalizado) ======
        async function findDocIdByCustomId(path, customId) {
        const qy = query(collection(db, path), where("id", "==", parseInt(customId)));
        const snap = await getDocs(qy);
        if (!snap.empty) return snap.docs[0].id; // usamos el primero
        return null;
        }

        // Cache simple de snapshots de historiales abiertos
        const _pagosListeners = {};
        const _aportesListeners = {};

        // Funciones de eliminaci√≥n - SE MANTIENE IGUAL
        window.eliminarIngreso = async function(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este ingreso?')) return;
            
            try {
                if (auth.currentUser) {
                    console.log("Buscando ingreso con ID:", id);
                    
                    // Buscar el documento por el ID personalizado
                    const q = query(
                        collection(db, "users", auth.currentUser.uid, "ingresos"),
                        where("id", "==", parseInt(id))
                    );
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        // Eliminar cada documento encontrado
                        const deletePromises = querySnapshot.docs.map(document => 
                            deleteDoc(doc(db, "users", auth.currentUser.uid, "ingresos", document.id))
                        );
                        await Promise.all(deletePromises);
                        console.log("Ingreso eliminado exitosamente");
                    } else {
                        console.log("No se encontr√≥ el ingreso para eliminar");
                        alert("No se pudo encontrar el ingreso para eliminar.");
                    }
                }
            } catch (e) { 
                console.error("Error al eliminar ingreso:", e); 
                alert("Error al eliminar el ingreso. Intenta nuevamente.");
            }
        }

        window.eliminarGasto = async function(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este gasto?')) return;
            
            try {
                if (auth.currentUser) {
                    console.log("Buscando gasto con ID:", id);
                    
                    const q = query(
                        collection(db, "users", auth.currentUser.uid, "gastos"),
                        where("id", "==", parseInt(id))
                    );
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const deletePromises = querySnapshot.docs.map(document => 
                            deleteDoc(doc(db, "users", auth.currentUser.uid, "gastos", document.id))
                        );
                        await Promise.all(deletePromises);
                        console.log("Gasto eliminado exitosamente");
                    } else {
                        console.log("No se encontr√≥ el gasto para eliminar");
                        alert("No se pudo encontrar el gasto para eliminar.");
                    }
                }
            } catch (e) { 
                console.error("Error al eliminar gasto:", e); 
                alert("Error al eliminar el gasto. Intenta nuevamente.");
            }
        }


        window.eliminarMeta = async function(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta meta?')) return;
            
            try {
                if (auth.currentUser) {
                    console.log("Buscando meta con ID:", id);
                    
                    const q = query(
                        collection(db, "users", auth.currentUser.uid, "metas"),
                        where("id", "==", parseInt(id))
                    );
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const deletePromises = querySnapshot.docs.map(document => 
                            deleteDoc(doc(db, "users", auth.currentUser.uid, "metas", document.id))
                        );
                        await Promise.all(deletePromises);
                        console.log("Meta eliminada exitosamente");
                    } else {
                        console.log("No se encontr√≥ la meta para eliminar");
                        alert("No se pudo encontrar la meta para eliminar.");
                    }
                }
            } catch (e) { 
                console.error("Error al eliminar meta:", e); 
                alert("Error al eliminar la meta. Intenta nuevamente.");
            }
        }

        window.eliminarDeuda = async function(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este registro?')) return;
            
            try {
                if (auth.currentUser) {
                    console.log("Buscando deuda con ID:", id);
                    
                    const q = query(
                        collection(db, "users", auth.currentUser.uid, "deudas"),
                        where("id", "==", parseInt(id))
                    );
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const deletePromises = querySnapshot.docs.map(document => 
                            deleteDoc(doc(db, "users", auth.currentUser.uid, "deudas", document.id))
                        );
                        await Promise.all(deletePromises);
                        console.log("Deuda eliminada exitosamente");
                    } else {
                        console.log("No se encontr√≥ la deuda para eliminar");
                        alert("No se pudo encontrar la deuda para eliminar.");
                    }
                }
            } catch (e) { 
                console.error("Error al eliminar deuda:", e); 
                alert("Error al eliminar la deuda. Intenta nuevamente.");
            }
        }

        window.abonarDeuda = async function(id) {
        const deuda = deudas.find(d => d.id === parseInt(id));
        if (!deuda) return;

        const abonoStr = prompt(`Ingresa el monto a abonar para "${deuda.concepto}":\nSaldo pendiente: S/ ${deuda.saldoPendiente.toFixed(2)}`, "0.00");
        if (abonoStr === null) return;

        const abono = parseFloat(abonoStr);
        if (isNaN(abono) || abono <= 0) return alert("Monto inv√°lido.");

        const nota = prompt("Nota (opcional):", "") || "";
        const nuevoSaldo = Math.max(0, deuda.saldoPendiente - abono);

        try {
            if (!auth.currentUser) return;
            const basePath = `users/${auth.currentUser.uid}/deudas`;
            const docId = await findDocIdByCustomId(basePath, id);
            if (!docId) return alert("No se encontr√≥ la deuda para actualizar.");

            // 1) Actualizar saldo
            await updateDoc(doc(db, basePath, docId), { saldoPendiente: nuevoSaldo });

            // 2) Registrar pago en subcolecci√≥n
            await addDoc(collection(db, basePath, docId, "pagos"), {
            monto: abono,
            fecha: new Date().toISOString(),
            nota
            });

            // Si el historial est√° abierto, ya se actualizar√° por onSnapshot
            console.log("Abono registrado y historial actualizado");
        } catch (e) {
            console.error(e);
            alert("Error al registrar el abono.");
        }
        };
        
        window.toggleHistorialDeuda = async function(customId) {
        const cont = document.getElementById(`historial-deuda-${customId}`);
        if (!cont) return;

        // Toggle visual
        const open = !cont.classList.contains('open');
        cont.classList.toggle('open');

        // Si lo abrimos por primera vez, levantar listener
        if (open && !_pagosListeners[customId] && auth.currentUser) {
            const docId = await findDocIdByCustomId(`users/${auth.currentUser.uid}/deudas`, customId);
            if (!docId) {
            cont.querySelector('.historial-pagos').innerHTML = `<div class="text-sm text-red-600">No se encontr√≥ la deuda.</div>`;
            return;
            }
            const pagosRefPath = `users/${auth.currentUser.uid}/deudas/${docId}/pagos`;
            _pagosListeners[customId] = onSnapshot(collection(db, pagosRefPath), (snap) => {
            const items = snap.docs
                .map(d => d.data())
                .sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

            const html = items.length === 0
                ? `<p class="text-gray-500 text-sm">Sin pagos a√∫n.</p>`
                : items.map(p => `
                    <div class="p-3 rounded-lg pago-item mb-2">
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-800">Pago</span>
                        <span class="font-semibold text-green-700">S/ ${Number(p.monto).toFixed(2)}</span>
                    </div>
                    <div class="text-xs text-gray-600">${formatearFecha(p.fecha)}</div>
                    ${p.nota ? `<div class="text-xs text-gray-500 mt-1">${p.nota}</div>` : ''}
                    </div>
                `).join('');

            cont.querySelector('.historial-pagos').innerHTML = html;
            });
        }
        };
        
        window.toggleHistorialMeta = async function(customId) {
        const cont = document.getElementById(`historial-meta-${customId}`);
        if (!cont) return;
        const open = !cont.classList.contains('open');
        cont.classList.toggle('open');

        if (open && !_aportesListeners[customId] && auth.currentUser) {
            const docId = await findDocIdByCustomId(`users/${auth.currentUser.uid}/metas`, customId);
            if (!docId) {
            cont.querySelector('.historial-pagos').innerHTML = `<div class="text-sm text-red-600">No se encontr√≥ la meta.</div>`;
            return;
            }
            const apRefPath = `users/${auth.currentUser.uid}/metas/${docId}/aportes`;
            _aportesListeners[customId] = onSnapshot(collection(db, apRefPath), (snap) => {
            const items = snap.docs
                .map(d => d.data())
                .sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

            const html = items.length === 0
                ? `<p class="text-gray-500 text-sm">Sin aportes a√∫n.</p>`
                : items.map(p => `
                    <div class="p-3 rounded-lg pago-item mb-2">
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-800">Aporte</span>
                        <span class="font-semibold text-green-700">S/ ${Number(p.monto).toFixed(2)}</span>
                    </div>
                    <div class="text-xs text-gray-600">${formatearFecha(p.fecha)}</div>
                    ${p.nota ? `<div class="text-xs text-gray-500 mt-1">${p.nota}</div>` : ''}
                    </div>
                `).join('');

            cont.querySelector('.historial-pagos').innerHTML = html;
            });
        }
        };
        
        window.actualizarAhorroMeta = async function(id) {
        const meta = metas.find(m => m.id === parseInt(id));
        if (!meta) return;

        const aporteStr = prompt(`Ingresa el monto a agregar a "${meta.nombre}":`, "0.00");
        if (aporteStr === null) return;
        const aporte = parseFloat(aporteStr);
        if (isNaN(aporte) || aporte <= 0) return alert("Monto inv√°lido.");

        const nota = prompt("Nota (opcional):", "") || "";
        const nuevoAhorro = (meta.ahorroActual || 0) + aporte;

        try {
            if (!auth.currentUser) return;
            const basePath = `users/${auth.currentUser.uid}/metas`;
            const docId = await findDocIdByCustomId(basePath, id);
            if (!docId) return alert("No se encontr√≥ la meta para actualizar.");

            // 1) actualizar ahorro
            await updateDoc(doc(db, basePath, docId), { ahorroActual: nuevoAhorro });
            // 2) guardar aporte
            await addDoc(collection(db, basePath, docId, "aportes"), {
            monto: aporte,
            fecha: new Date().toISOString(),
            nota
            });
        } catch (e) {
            console.warn("No se pudo actualizar en Firestore:", e);
            alert("Error al actualizar el ahorro.");
        }
        };
        
        window.abonarPrestamo = async function(id) {
            const prestamo = prestamos.find(p => p.id === parseInt(id));
            if (!prestamo) return;

            const cobroStr = prompt(`Ingresa el monto cobrado de "${prestamo.concepto}":\nSaldo pendiente: S/ ${prestamo.saldoPendiente.toFixed(2)}`, "0.00");
            if (cobroStr === null) return;

            const cobro = parseFloat(cobroStr);
            if (isNaN(cobro) || cobro <= 0) return alert("Monto inv√°lido.");

            const nota = prompt("Nota (opcional):", "") || "";
            const nuevoSaldo = Math.max(0, prestamo.saldoPendiente - cobro);

            try {
                if (!auth.currentUser) return;
                const basePath = `users/${auth.currentUser.uid}/prestamos`;
                const docId = await findDocIdByCustomId(basePath, id);
                if (!docId) return alert("No se encontr√≥ el pr√©stamo para actualizar.");

                // 1) Actualizar saldo
                await updateDoc(doc(db, basePath, docId), { saldoPendiente: nuevoSaldo });

                // 2) Registrar cobro en subcolecci√≥n
                await addDoc(collection(db, basePath, docId, "cobros"), {
                    monto: cobro,
                    fecha: new Date().toISOString(),
                    nota
                });

                console.log("Cobro registrado y historial actualizado");
            } catch (e) {
                console.error(e);
                alert("Error al registrar el cobro.");
            }
        };
        
        window.eliminarPrestamo = async function(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este pr√©stamo?')) return;
            
            try {
                if (auth.currentUser) {
                    console.log("Buscando pr√©stamo con ID:", id);
                    
                    const q = query(
                        collection(db, "users", auth.currentUser.uid, "prestamos"),
                        where("id", "==", parseInt(id))
                    );
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const deletePromises = querySnapshot.docs.map(document => 
                            deleteDoc(doc(db, "users", auth.currentUser.uid, "prestamos", document.id))
                        );
                        await Promise.all(deletePromises);
                        console.log("Pr√©stamo eliminado exitosamente");
                    } else {
                        console.log("No se encontr√≥ el pr√©stamo para eliminar");
                        alert("No se pudo encontrar el pr√©stamo para eliminar.");
                    }
                }
            } catch (e) { 
                console.error("Error al eliminar pr√©stamo:", e); 
                alert("Error al eliminar el pr√©stamo. Intenta nuevamente.");
            }
        };
        
        // MODIFICADO: Configurar listeners optimizados
        function configurarListenersTiempoReal(uid) {
            // Listener para ingresos
            onSnapshot(collection(db, "users", uid, "ingresos"), (snapshot) => {
                ingresos = snapshot.docs.map(doc => ({ ...doc.data(), firebaseId: doc.id }));
                actualizarIngresos();
                actualizarResumen();
                actualizarPresupuesto();
                // MODIFICADO: Solo actualizar gr√°ficos si est√°n visibles
                if (document.getElementById('ingresos').classList.contains('active')) {
                    actualizarGraficoIngresos();
                }
            });

            // Listener para gastos
            onSnapshot(collection(db, "users", uid, "gastos"), (snapshot) => {
                gastos = snapshot.docs.map(doc => ({ ...doc.data(), firebaseId: doc.id }));
                actualizarGastos();
                actualizarResumen();
                // MODIFICADO: Solo actualizar gr√°ficos si est√°n visibles
                if (document.getElementById('gastos').classList.contains('active')) {
                    actualizarGraficoGastos();
                }
            });

            // Listener para metas
            onSnapshot(collection(db, "users", uid, "metas"), (snapshot) => {
                metas = snapshot.docs.map(doc => ({ ...doc.data(), firebaseId: doc.id }));
                actualizarMetas();
            });

            // Listener para presupuestos
            onSnapshot(collection(db, "users", uid, "presupuestos"), (snapshot) => {
                presupuestos = snapshot.docs.map(doc => ({ ...doc.data(), firebaseId: doc.id }));
                actualizarPresupuesto();
                // MODIFICADO: Solo actualizar gr√°ficos si est√°n visibles
                if (document.getElementById('presupuesto').classList.contains('active')) {
                    actualizarGraficoPresupuesto();
                }
            });

            onSnapshot(collection(db, "users", uid, "deudas"), (snapshot) => {
                deudas = snapshot.docs.map(doc => ({ ...doc.data(), firebaseId: doc.id }));
                actualizarDeudas();
            });

            // Listener para pr√©stamos
            onSnapshot(collection(db, "users", uid, "prestamos"), (snapshot) => {
                prestamos = snapshot.docs.map(doc => ({ ...doc.data(), firebaseId: doc.id }));
                actualizarPrestamos();
                // MODIFICADO: Solo actualizar si est√° visible
                if (document.getElementById('prestamos').classList.contains('active')) {
                    actualizarPrestamos();
                }
            });
        }

        // INICIALIZACI√ìN CORREGIDA - Sin autenticaci√≥n an√≥nima
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuario autenticado (con email/contrase√±a)
                console.log("Usuario autenticado:", user.email);
                loginSection.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                // Configurar listeners en tiempo real
                configurarListenersTiempoReal(user.uid);
                
                // Cargar gr√°ficos despu√©s de un delay
                setTimeout(() => {
                    actualizarGraficoIngresos();
                    actualizarGraficoGastos();
                    actualizarResumenAnual();
                    graficosCargados = true;
                }, 1000);
                
            } else {
                // No hay usuario autenticado - MOSTRAR LOGIN
                console.log("No hay usuario autenticado");
                loginSection.classList.remove('hidden');
                mainApp.classList.add('hidden');
                
                // Limpiar datos locales cuando no hay usuario
                ingresos = [];
                gastos = [];
                metas = [];
                presupuestos = [];
                
                // Actualizar la UI para mostrar estado vac√≠o
                actualizarIngresos();
                actualizarGastos();
                actualizarMetas();
                actualizarPresupuesto();
                actualizarResumen();
            }
        });
  </script>
</body>
</html>



